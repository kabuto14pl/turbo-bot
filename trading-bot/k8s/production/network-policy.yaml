# üöÄ [PRODUCTION-CONFIG]
# Production deployment configuration
# üîê NETWORK SECURITY POLICIES
# Kubernetes Network Policies for zero-trust networking
# Implements micro-segmentation and defense-in-depth

apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: trading-bot-network-policy
  namespace: trading-bot-final-production
  labels:
    app: trading-bot
    security-zone: production
spec:
  podSelector:
    matchLabels:
      app: trading-bot
  policyTypes:
  - Ingress
  - Egress
  
  # ============================================================================
  # INGRESS RULES - What can connect TO the trading bot
  # ============================================================================
  ingress:
  # Allow traffic from load balancer
  - from:
    - namespaceSelector:
        matchLabels:
          name: ingress-nginx
    - podSelector:
        matchLabels:
          app.kubernetes.io/name: ingress-nginx
    ports:
    - protocol: TCP
      port: 3000

  # Allow traffic from monitoring (Prometheus)
  - from:
    - namespaceSelector:
        matchLabels:
          name: monitoring
    - podSelector:
        matchLabels:
          app: prometheus
    ports:
    - protocol: TCP
      port: 9090

  # Allow traffic from same namespace (sidecar communication)
  - from:
    - podSelector:
        matchLabels:
          app: trading-bot
    ports:
    - protocol: TCP
      port: 3000

  # ============================================================================
  # EGRESS RULES - What the trading bot can connect TO
  # ============================================================================
  egress:
  # Allow DNS resolution
  - to: []
    ports:
    - protocol: UDP
      port: 53
    - protocol: TCP
      port: 53

  # Allow HTTPS to trading exchanges (Binance, Coinbase, etc.)
  - to: []
    ports:
    - protocol: TCP
      port: 443
    - protocol: TCP
      port: 80

  # Allow connection to database
  - to:
    - namespaceSelector:
        matchLabels:
          name: database
    - podSelector:
        matchLabels:
          app: postgresql
    ports:
    - protocol: TCP
      port: 5432

  # Allow connection to Redis cache
  - to:
    - namespaceSelector:
        matchLabels:
          name: database
    - podSelector:
        matchLabels:
          app: redis
    ports:
    - protocol: TCP
      port: 6379

  # Allow connection to logging infrastructure
  - to:
    - namespaceSelector:
        matchLabels:
          name: logging
    - podSelector:
        matchLabels:
          app: elasticsearch
    ports:
    - protocol: TCP
      port: 9200

  # Allow connection to monitoring
  - to:
    - namespaceSelector:
        matchLabels:
          name: monitoring
    ports:
    - protocol: TCP
      port: 8080
    - protocol: TCP
      port: 9090

---
# ============================================================================
# POD SECURITY POLICY (Deprecated but showing for reference)
# This is replaced by Pod Security Standards in modern K8s
# ============================================================================
apiVersion: security.istio.io/v1beta1
kind: PeerAuthentication
metadata:
  name: trading-bot-mtls
  namespace: trading-bot-final-production
spec:
  selector:
    matchLabels:
      app: trading-bot
  mtls:
    mode: STRICT

---
apiVersion: security.istio.io/v1beta1
kind: AuthorizationPolicy
metadata:
  name: trading-bot-authz
  namespace: trading-bot-final-production
spec:
  selector:
    matchLabels:
      app: trading-bot
  rules:
  # Allow ingress traffic
  - from:
    - source:
        namespaces: ["ingress-nginx"]
    to:
    - operation:
        methods: ["GET", "POST"]
        paths: ["/api/*", "/health/*"]
  
  # Allow monitoring traffic
  - from:
    - source:
        namespaces: ["monitoring"]
    to:
    - operation:
        methods: ["GET"]
        paths: ["/metrics", "/health/*"]

---
# ============================================================================
# CALICO NETWORK POLICY (If using Calico CNI)
# ============================================================================
apiVersion: projectcalico.org/v3
kind: NetworkPolicy
metadata:
  name: trading-bot-strict-egress
  namespace: trading-bot-final-production
spec:
  selector: app == "trading-bot"
  types:
  - Egress
  egress:
  # Allow DNS
  - action: Allow
    protocol: UDP
    destination:
      ports:
      - 53
  - action: Allow
    protocol: TCP
    destination:
      ports:
      - 53

  # Allow HTTPS to specific trading exchange IPs
  - action: Allow
    protocol: TCP
    destination:
      nets:
      - 54.230.0.0/15    # Binance CDN
      - 52.84.0.0/15     # Coinbase Pro
      - 13.107.42.14/32  # Kraken
      ports:
      - 443

  # Allow database connections
  - action: Allow
    protocol: TCP
    destination:
      selector: app == "postgresql"
      ports:
      - 5432

  # Allow Redis connections
  - action: Allow
    protocol: TCP
    destination:
      selector: app == "redis"
      ports:
      - 6379

  # Deny all other egress
  - action: Deny
