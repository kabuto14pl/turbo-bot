apiVersion: v1
kind: ConfigMap
metadata:
  name: trading-bot-config
  namespace: trading-bot-final-production
  labels:
    app: trading-bot
data:
  # Application Configuration
  NODE_ENV: "production"
  LOG_LEVEL: "info"
  DATA_RETENTION_DAYS: "90"
  ENCRYPTION_ENABLED: "true"
  AUDIT_LOGGING_ENABLED: "true"
  
  # Trading Configuration
  INITIAL_CAPITAL: "10000"
  MAX_DRAWDOWN: "0.15"
  MAX_DAILY_DRAWDOWN: "0.05"
  TRADING_INTERVAL: "30000"
  AUTO_HEDGING: "true"
  
  # Kafka Configuration
  KAFKA_ENABLED: "true"
  KAFKA_BROKERS: "kafka-cluster:9092"
  KAFKA_TOPICS: "market-data,sentiment-data,trading-signals"
  
  # Database Configuration
  DUCKDB_PATH: "/app/data/trading_data.duckdb"
  
  # Monitoring Configuration
  PROMETHEUS_PORT: "9090"
  METRICS_ENABLED: "true"
  HEALTH_CHECK_PORT: "3000"
  
  # Performance Configuration
  MAX_CONCURRENT_TRADES: "5"
  POSITION_SIZE_LIMIT: "0.1"
  
  # Security Configuration
  GDPR_COMPLIANCE_MODE: "strict"
  SECURITY_HEADERS_ENABLED: "true"
  RATE_LIMITING_ENABLED: "true"

---
apiVersion: v1
kind: ConfigMap
metadata:
  name: fluent-bit-config
  namespace: trading-production
  labels:
    app: trading-bot
data:
  fluent-bit.conf: |
    [SERVICE]
        Flush        1
        Daemon       Off
        Log_Level    info
        Parsers_File parsers.conf

    [INPUT]
        Name              tail
        Path              /app/logs/*.log
        Parser            json
        Tag               trading-bot.*
        Refresh_Interval  5
        Skip_Long_Lines   On

    [INPUT]
        Name              tail
        Path              /app/logs/gdpr-audit/*.log
        Parser            json
        Tag               gdpr-audit.*
        Refresh_Interval  5

    [FILTER]
        Name   grep
        Match  trading-bot.*
        Regex  level (ERROR|WARN|INFO)

    [OUTPUT]
        Name  stdout
        Match *
        Format json_lines

    [OUTPUT]
        Name  prometheus_exporter
        Match *
        Host  0.0.0.0
        Port  2020

  parsers.conf: |
    [PARSER]
        Name        json
        Format      json
        Time_Key    time
        Time_Format %Y-%m-%dT%H:%M:%S.%LZ

---
apiVersion: v1
kind: ConfigMap
metadata:
  name: prometheus-config
  namespace: trading-production
  labels:
    app: monitoring
data:
  prometheus.yml: |
    global:
      scrape_interval: 15s
      evaluation_interval: 15s

    rule_files:
      - "trading_bot_rules.yml"

    alerting:
      alertmanagers:
        - static_configs:
            - targets:
              - alertmanager:9093

    scrape_configs:
      - job_name: 'trading-bot'
        static_configs:
          - targets: ['trading-bot-service:9090']
        scrape_interval: 5s
        metrics_path: /metrics

      - job_name: 'kubernetes-pods'
        kubernetes_sd_configs:
          - role: pod
            namespaces:
              names:
                - trading-production
        relabel_configs:
          - source_labels: [__meta_kubernetes_pod_annotation_prometheus_io_scrape]
            action: keep
            regex: true
          - source_labels: [__meta_kubernetes_pod_annotation_prometheus_io_path]
            action: replace
            target_label: __metrics_path__
            regex: (.+)

  trading_bot_rules.yml: |
    groups:
      - name: trading_bot_alerts
        rules:
          - alert: TradingBotDown
            expr: up{job="trading-bot"} == 0
            for: 1m
            labels:
              severity: critical
            annotations:
              summary: "Trading Bot instance is down"
              description: "Trading Bot {{ $labels.instance }} has been down for more than 1 minute."

          - alert: HighMemoryUsage
            expr: trading_bot_memory_usage_mb > 1500
            for: 5m
            labels:
              severity: warning
            annotations:
              summary: "High memory usage on Trading Bot"
              description: "Trading Bot memory usage is {{ $value }}MB"

          - alert: TradingBotRestarted
            expr: increase(trading_bot_uptime_seconds[5m]) < 0
            for: 0m
            labels:
              severity: info
            annotations:
              summary: "Trading Bot has restarted"
              description: "Trading Bot instance {{ $labels.instance }} has restarted"

---
apiVersion: v1
kind: ConfigMap
metadata:
  name: grafana-dashboards
  namespace: trading-production
  labels:
    app: monitoring
data:
  trading-bot-dashboard.json: |
    {
      "dashboard": {
        "id": null,
        "title": "Trading Bot Production Dashboard",
        "tags": ["trading", "production"],
        "timezone": "browser",
        "panels": [
          {
            "id": 1,
            "title": "Trading Bot Uptime",
            "type": "stat",
            "targets": [
              {
                "expr": "trading_bot_uptime_seconds",
                "legendFormat": "Uptime"
              }
            ],
            "fieldConfig": {
              "defaults": {
                "unit": "s"
              }
            }
          },
          {
            "id": 2,
            "title": "Memory Usage",
            "type": "timeseries",
            "targets": [
              {
                "expr": "trading_bot_memory_usage_mb",
                "legendFormat": "Memory (MB)"
              }
            ]
          },
          {
            "id": 3,
            "title": "Health Status",
            "type": "stat",
            "targets": [
              {
                "expr": "trading_bot_health_status",
                "legendFormat": "Health"
              }
            ],
            "fieldConfig": {
              "defaults": {
                "mappings": [
                  {
                    "options": {
                      "0": {
                        "text": "Unhealthy",
                        "color": "red"
                      },
                      "1": {
                        "text": "Healthy",
                        "color": "green"
                      }
                    },
                    "type": "value"
                  }
                ]
              }
            }
          }
        ],
        "time": {
          "from": "now-1h",
          "to": "now"
        },
        "refresh": "10s"
      }
    }
