<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üöÄ Enterprise Trading Bot Dashboard</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: linear-gradient(135deg, #0a0e27 0%, #1a1f3a 100%);
            color: #ffffff;
            min-height: 100vh;
            padding: 20px;
        }
        
        .container {
            max-width: 1600px;
            margin: 0 auto;
        }
        
        .header {
            text-align: center;
            margin-bottom: 30px;
            background: linear-gradient(135deg, rgba(0, 245, 255, 0.1) 0%, rgba(74, 222, 128, 0.1) 100%);
            border-radius: 16px;
            padding: 30px;
            border: 1px solid rgba(0, 245, 255, 0.2);
        }
        
        .header h1 {
            font-size: 2.5rem;
            font-weight: 700;
            background: linear-gradient(135deg, #00f5ff 0%, #4ade80 100%);
            -webkit-background-clip: text;
            background-clip: text;
            -webkit-text-fill-color: transparent;
            margin-bottom: 10px;
        }
        
        .status-badge {
            display: inline-block;
            padding: 8px 20px;
            border-radius: 20px;
            font-weight: 600;
            font-size: 0.9rem;
            margin-top: 10px;
        }
        
        .status-healthy { background: rgba(74, 222, 128, 0.2); color: #4ade80; border: 1px solid #4ade80; }
        .status-degraded { background: rgba(251, 191, 36, 0.2); color: #fbbf24; border: 1px solid #fbbf24; }
        .status-critical { background: rgba(248, 113, 113, 0.2); color: #f87171; border: 1px solid #f87171; }
        
        .grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }
        
        .card {
            background: rgba(26, 31, 58, 0.8);
            border-radius: 12px;
            padding: 24px;
            border: 1px solid rgba(0, 245, 255, 0.1);
            transition: all 0.3s ease;
        }
        
        .card:hover {
            transform: translateY(-4px);
            border-color: rgba(0, 245, 255, 0.3);
            box-shadow: 0 8px 32px rgba(0, 245, 255, 0.15);
        }
        
        .card-title {
            font-size: 1.1rem;
            color: #00f5ff;
            margin-bottom: 16px;
            display: flex;
            align-items: center;
            gap: 8px;
            font-weight: 600;
        }
        
        .metric-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px 0;
            border-bottom: 1px solid rgba(255, 255, 255, 0.05);
        }
        
        .metric-row:last-child {
            border-bottom: none;
        }
        
        .metric-label {
            color: #aaa;
            font-size: 0.9rem;
        }
        
        .metric-value {
            color: #fff;
            font-weight: 600;
            font-size: 1.1rem;
        }
        
        .metric-value.positive { color: #4ade80; }
        .metric-value.negative { color: #f87171; }
        .metric-value.neutral { color: #00f5ff; }
        
        .big-metric {
            text-align: center;
            padding: 20px;
            background: rgba(0, 245, 255, 0.05);
            border-radius: 8px;
            margin-bottom: 16px;
        }
        
        .big-metric-value {
            font-size: 2.5rem;
            font-weight: 700;
            margin-bottom: 8px;
        }
        
        .big-metric-label {
            color: #aaa;
            font-size: 0.9rem;
            text-transform: uppercase;
            letter-spacing: 1px;
        }
        
        .trades-list {
            max-height: 400px;
            overflow-y: auto;
        }
        
        .trade-item {
            background: rgba(0, 245, 255, 0.05);
            padding: 12px;
            border-radius: 8px;
            margin-bottom: 8px;
            border-left: 3px solid #00f5ff;
        }
        
        .trade-item.buy { border-left-color: #4ade80; }
        .trade-item.sell { border-left-color: #f87171; }
        
        .trade-header {
            display: flex;
            justify-content: space-between;
            margin-bottom: 8px;
        }
        
        .trade-action {
            font-weight: 600;
            padding: 4px 12px;
            border-radius: 4px;
            font-size: 0.85rem;
        }
        
        .trade-action.buy { background: rgba(74, 222, 128, 0.2); color: #4ade80; }
        .trade-action.sell { background: rgba(248, 113, 113, 0.2); color: #f87171; }
        
        .components-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 12px;
        }
        
        .component {
            background: rgba(0, 245, 255, 0.05);
            padding: 12px;
            border-radius: 8px;
            text-align: center;
            border: 1px solid rgba(0, 245, 255, 0.1);
        }
        
        .component.active {
            border-color: #4ade80;
            background: rgba(74, 222, 128, 0.1);
        }
        
        .component.inactive {
            border-color: #f87171;
            background: rgba(248, 113, 113, 0.1);
        }
        
        .component-name {
            font-size: 0.85rem;
            color: #aaa;
            margin-bottom: 4px;
        }
        
        .component-status {
            font-weight: 600;
            font-size: 0.9rem;
        }
        
        .refresh-button {
            background: linear-gradient(135deg, #00f5ff 0%, #4ade80 100%);
            color: #0a0e27;
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            font-size: 1rem;
            transition: all 0.3s ease;
            margin-bottom: 20px;
        }
        
        .refresh-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 20px rgba(0, 245, 255, 0.4);
        }
        
        .alert {
            background: rgba(248, 113, 113, 0.2);
            border: 1px solid #f87171;
            border-radius: 8px;
            padding: 16px;
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            gap: 12px;
        }
        
        .alert-icon {
            font-size: 1.5rem;
        }
        
        .last-update {
            text-align: center;
            color: #888;
            font-size: 0.85rem;
            margin-top: 20px;
        }
        
        .loading {
            text-align: center;
            padding: 40px;
            color: #00f5ff;
            font-size: 1.2rem;
        }
        
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }
        
        .loading::after {
            content: '...';
            animation: pulse 1.5s infinite;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üöÄ Enterprise Trading Bot Dashboard</h1>
            <div id="statusBadge" class="status-badge">Loading...</div>
        </div>

        <button class="refresh-button" onclick="refreshAll()">üîÑ Refresh Dashboard</button>

        <div id="alertContainer"></div>

        <div class="grid">
            <!-- Portfolio Card -->
            <div class="card">
                <div class="card-title">üí∞ Portfolio Performance</div>
                <div class="big-metric">
                    <div class="big-metric-value" id="totalValue">$0</div>
                    <div class="big-metric-label">Total Value</div>
                </div>
                <div class="metric-row">
                    <span class="metric-label">Realized P&L</span>
                    <span class="metric-value" id="realizedPnL">$0</span>
                </div>
                <div class="metric-row">
                    <span class="metric-label">Unrealized P&L</span>
                    <span class="metric-value" id="unrealizedPnL">$0</span>
                </div>
                <div class="metric-row">
                    <span class="metric-label">Drawdown</span>
                    <span class="metric-value" id="drawdown">0%</span>
                </div>
                <div class="metric-row">
                    <span class="metric-label">Total Trades</span>
                    <span class="metric-value neutral" id="totalTrades">0</span>
                </div>
                <div class="metric-row">
                    <span class="metric-label">Win Rate</span>
                    <span class="metric-value" id="winRate">0%</span>
                </div>
            </div>

            <!-- Trading Status Card -->
            <div class="card">
                <div class="card-title">üìä Trading Status</div>
                <div class="metric-row">
                    <span class="metric-label">Symbol</span>
                    <span class="metric-value neutral" id="symbol">-</span>
                </div>
                <div class="metric-row">
                    <span class="metric-label">Timeframe</span>
                    <span class="metric-value neutral" id="timeframe">-</span>
                </div>
                <div class="metric-row">
                    <span class="metric-label">Strategy</span>
                    <span class="metric-value neutral" id="strategy">-</span>
                </div>
                <div class="metric-row">
                    <span class="metric-label">Trading Mode</span>
                    <span class="metric-value neutral" id="tradingMode">-</span>
                </div>
                <div class="metric-row">
                    <span class="metric-label">Uptime</span>
                    <span class="metric-value neutral" id="uptime">-</span>
                </div>
                <div class="metric-row">
                    <span class="metric-label">Strategies Count</span>
                    <span class="metric-value neutral" id="strategiesCount">0</span>
                </div>
            </div>

            <!-- ML Ensemble Card -->
            <div class="card">
                <div class="card-title">üß† ML Ensemble (TIER 3)</div>
                <div class="big-metric">
                    <div class="big-metric-value neutral" id="ensembleAccuracy">0%</div>
                    <div class="big-metric-label">Accuracy</div>
                </div>
                <div class="metric-row">
                    <span class="metric-label">Total Predictions</span>
                    <span class="metric-value neutral" id="totalPredictions">0</span>
                </div>
                <div class="metric-row">
                    <span class="metric-label">Win Rate</span>
                    <span class="metric-value" id="ensembleWinRate">0%</span>
                </div>
                <div class="metric-row">
                    <span class="metric-label">Sharpe Ratio</span>
                    <span class="metric-value" id="ensembleSharpe">0</span>
                </div>
                <div class="metric-row">
                    <span class="metric-label">Best Model</span>
                    <span class="metric-value neutral" id="bestModel">-</span>
                </div>
                <div class="metric-row">
                    <span class="metric-label">Unanimous Decisions</span>
                    <span class="metric-value neutral" id="unanimousDecisions">0</span>
                </div>
            </div>
        </div>

        <!-- System Components -->
        <div class="card">
            <div class="card-title">‚öôÔ∏è System Components</div>
            <div class="components-grid" id="componentsGrid">
                <div class="loading">Loading components</div>
            </div>
        </div>

        <!-- Recent Trades -->
        <div class="card">
            <div class="card-title">üìà Recent Trades</div>
            <div class="trades-list" id="tradesList">
                <div class="loading">Loading trades</div>
            </div>
        </div>

        <div class="last-update">
            Last updated: <span id="lastUpdate">Never</span>
        </div>
    </div>

    <script>
        let autoRefreshInterval;

        function formatCurrency(value) {
            return new Intl.NumberFormat('en-US', {
                style: 'currency',
                currency: 'USD',
                minimumFractionDigits: 2,
                maximumFractionDigits: 2
            }).format(value);
        }

        function formatPercent(value) {
            return (value * 100).toFixed(2) + '%';
        }

        function formatUptime(seconds) {
            const hours = Math.floor(seconds / 3600);
            const minutes = Math.floor((seconds % 3600) / 60);
            const secs = Math.floor(seconds % 60);
            return `${hours}h ${minutes}m ${secs}s`;
        }

        function setMetricValue(id, value, isPositive = null) {
            const element = document.getElementById(id);
            if (!element) return;
            
            element.textContent = value;
            
            if (isPositive !== null) {
                element.className = 'metric-value ' + (isPositive ? 'positive' : 'negative');
            }
        }

        async function fetchHealth() {
            try {
                const response = await fetch('/health');
                const data = await response.json();
                
                // Update status badge
                const statusBadge = document.getElementById('statusBadge');
                statusBadge.textContent = data.status.toUpperCase();
                statusBadge.className = 'status-badge status-' + data.status;
                
                // Update uptime
                setMetricValue('uptime', formatUptime(data.uptime));
                
                // Update portfolio metrics
                setMetricValue('totalValue', formatCurrency(data.metrics.totalValue));
                setMetricValue('realizedPnL', formatCurrency(data.metrics.realizedPnL), data.metrics.realizedPnL >= 0);
                setMetricValue('unrealizedPnL', formatCurrency(data.metrics.unrealizedPnL), data.metrics.unrealizedPnL >= 0);
                setMetricValue('drawdown', formatPercent(data.metrics.drawdown), data.metrics.drawdown <= 0.05);
                setMetricValue('totalTrades', data.metrics.totalTrades);
                setMetricValue('winRate', formatPercent(data.metrics.winRate), data.metrics.winRate >= 0.5);
                
                // Update components
                const componentsGrid = document.getElementById('componentsGrid');
                componentsGrid.innerHTML = Object.entries(data.components).map(([name, status]) => `
                    <div class="component ${status ? 'active' : 'inactive'}">
                        <div class="component-name">${name}</div>
                        <div class="component-status">${status ? '‚úÖ Active' : '‚ùå Inactive'}</div>
                    </div>
                `).join('');
                
                // Show alert if circuit breaker tripped
                const alertContainer = document.getElementById('alertContainer');
                if (data.metrics.circuitBreakerTripped) {
                    alertContainer.innerHTML = `
                        <div class="alert">
                            <div class="alert-icon">‚ö†Ô∏è</div>
                            <div>
                                <strong>Circuit Breaker Triggered!</strong><br>
                                Trading halted after ${data.metrics.circuitBreakerTripCount} consecutive losses.
                            </div>
                        </div>
                    `;
                } else {
                    alertContainer.innerHTML = '';
                }
                
            } catch (error) {
                console.error('Error fetching health:', error);
            }
        }

        async function fetchStatus() {
            try {
                const response = await fetch('/api/status');
                const data = await response.json();
                
                setMetricValue('symbol', data.config.symbol);
                setMetricValue('timeframe', data.config.timeframe);
                setMetricValue('strategy', data.config.strategy);
                setMetricValue('tradingMode', data.config.paperTrading ? 'üìù Paper Trading' : 'üí∞ Live Trading');
                setMetricValue('strategiesCount', data.trading.strategiesCount);
                
            } catch (error) {
                console.error('Error fetching status:', error);
            }
        }

        async function fetchEnsemble() {
            try {
                const response = await fetch('/api/ensemble/status');
                const data = await response.json();
                
                if (data.enabled) {
                    setMetricValue('ensembleAccuracy', formatPercent(data.accuracy), data.accuracy >= 0.6);
                    setMetricValue('totalPredictions', data.totalPredictions);
                    setMetricValue('ensembleWinRate', formatPercent(data.winRate), data.winRate >= 0.5);
                    setMetricValue('ensembleSharpe', data.sharpe.toFixed(2), data.sharpe >= 1);
                    setMetricValue('bestModel', data.bestModel);
                    setMetricValue('unanimousDecisions', data.unanimousDecisions);
                }
                
            } catch (error) {
                console.error('Error fetching ensemble:', error);
            }
        }

        async function fetchTrades() {
            try {
                const response = await fetch('/api/trades?limit=10');
                const data = await response.json();
                
                const tradesList = document.getElementById('tradesList');
                
                if (data.trades.length === 0) {
                    tradesList.innerHTML = '<div style="text-align: center; color: #888; padding: 20px;">No trades yet</div>';
                    return;
                }
                
                tradesList.innerHTML = data.trades.map(trade => {
                    const action = trade.action.toLowerCase();
                    const pnlClass = trade.pnl >= 0 ? 'positive' : 'negative';
                    const time = new Date(trade.timestamp).toLocaleTimeString();
                    
                    return `
                        <div class="trade-item ${action}">
                            <div class="trade-header">
                                <span class="trade-action ${action}">${trade.action}</span>
                                <span style="color: #888; font-size: 0.85rem;">${time}</span>
                            </div>
                            <div class="metric-row">
                                <span class="metric-label">Price</span>
                                <span class="metric-value neutral">${formatCurrency(trade.price)}</span>
                            </div>
                            <div class="metric-row">
                                <span class="metric-label">Quantity</span>
                                <span class="metric-value neutral">${trade.quantity.toFixed(6)}</span>
                            </div>
                            <div class="metric-row">
                                <span class="metric-label">P&L</span>
                                <span class="metric-value ${pnlClass}">${formatCurrency(trade.pnl)}</span>
                            </div>
                            <div class="metric-row">
                                <span class="metric-label">Strategy</span>
                                <span class="metric-value neutral" style="font-size: 0.85rem;">${trade.strategy}</span>
                            </div>
                        </div>
                    `;
                }).join('');
                
            } catch (error) {
                console.error('Error fetching trades:', error);
            }
        }

        async function refreshAll() {
            await Promise.all([
                fetchHealth(),
                fetchStatus(),
                fetchEnsemble(),
                fetchTrades()
            ]);
            
            document.getElementById('lastUpdate').textContent = new Date().toLocaleTimeString();
        }

        // Auto-refresh every 5 seconds
        function startAutoRefresh() {
            refreshAll();
            autoRefreshInterval = setInterval(refreshAll, 5000);
        }

        // Initial load
        startAutoRefresh();
    </script>
</body>
</html>
