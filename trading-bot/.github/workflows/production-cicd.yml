# üöÄ PRODUCTION-READY CI/CD PIPELINE
# Comprehensive DevSecOps pipeline with security scanning, automated testing, and deployment
# Implements security-first approach for trading bot deployment

name: Production Trading Bot CI/CD

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]
  release:
    types: [ published ]

env:
  NODE_VERSION: '18.x'
  PYTHON_VERSION: '3.11'
  REGISTRY: ghcr.io
  IMAGE_NAME: ${{ github.repository }}

# ============================================================================
# SECURITY PERMISSIONS
# ============================================================================
permissions:
  contents: read
  security-events: write
  actions: read
  packages: write
  id-token: write

jobs:
  # ============================================================================
  # SECURITY SCANNING
  # ============================================================================
  security-scan:
    name: üîí Security Analysis
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Run dependency vulnerability scan
        run: |
          npm audit --audit-level=moderate
          npm run security:audit
        continue-on-error: false

      - name: CodeQL Analysis
        uses: github/codeql-action/init@v3
        with:
          languages: javascript,typescript
          config-file: ./.github/codeql/codeql-config.yml

      - name: Perform CodeQL Analysis
        uses: github/codeql-action/analyze@v3

      - name: Run SAST with Semgrep
        uses: semgrep/semgrep-action@v1
        with:
          config: >-
            p/security-audit
            p/secrets
            p/owasp-top-ten
            p/typescript
          generateSarif: "1"
        env:
          SEMGREP_APP_TOKEN: ${{ secrets.SEMGREP_APP_TOKEN }}

      - name: Upload SARIF file
        uses: github/codeql-action/upload-sarif@v3
        with:
          sarif_file: semgrep.sarif
        if: always()

      - name: Secrets scanning with TruffleHog
        uses: trufflesecurity/trufflehog@main
        with:
          path: ./
          base: main
          head: HEAD
          extra_args: --debug --only-verified

  # ============================================================================
  # CODE QUALITY & TESTING
  # ============================================================================
  quality-assurance:
    name: üß™ Quality Assurance
    runs-on: ubuntu-latest
    needs: security-scan
    strategy:
      matrix:
        node-version: [16.x, 18.x, 20.x]
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js ${{ matrix.node-version }}
        uses: actions/setup-node@v4
        with:
          node-version: ${{ matrix.node-version }}
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: TypeScript compilation check
        run: npm run build:check

      - name: Run ESLint with security rules
        run: npm run lint:security

      - name: Run comprehensive tests
        run: |
          npm run test:unit
          npm run test:integration
          npm run test:security
          npm run test:performance
        env:
          CI: true
          NODE_ENV: test

      - name: Generate test coverage
        run: npm run test:coverage

      - name: Upload coverage to Codecov
        uses: codecov/codecov-action@v3
        with:
          file: ./coverage/lcov.info
          flags: unittests
          name: codecov-umbrella

      - name: SonarCloud Scan
        uses: SonarSource/sonarcloud-github-action@master
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}

  # ============================================================================
  # CONTAINER SECURITY
  # ============================================================================
  container-security:
    name: üê≥ Container Security
    runs-on: ubuntu-latest
    needs: quality-assurance
    if: github.event_name != 'pull_request'
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Log in to Container Registry
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Extract metadata
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}
          tags: |
            type=ref,event=branch
            type=ref,event=pr
            type=sha,prefix=commit-
            type=raw,value=latest,enable={{is_default_branch}}

      - name: Build container image
        uses: docker/build-push-action@v5
        with:
          context: .
          file: ./Dockerfile.production
          push: false
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}
          cache-from: type=gha
          cache-to: type=gha,mode=max
          platforms: linux/amd64,linux/arm64

      - name: Run Trivy vulnerability scanner
        uses: aquasecurity/trivy-action@master
        with:
          image-ref: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:latest
          format: 'sarif'
          output: 'trivy-results.sarif'

      - name: Upload Trivy scan results
        uses: github/codeql-action/upload-sarif@v3
        with:
          sarif_file: 'trivy-results.sarif'

      - name: Docker Scout CVE scanning
        uses: docker/scout-action@v1
        with:
          command: cves
          image: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:latest
          sarif-file: scout-cves.sarif

  # ============================================================================
  # GDPR COMPLIANCE CHECK
  # ============================================================================
  gdpr-compliance:
    name: üîê GDPR Compliance Verification
    runs-on: ubuntu-latest
    needs: quality-assurance
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Run GDPR compliance tests
        run: npm run test:gdpr-compliance
        env:
          GDPR_COMPLIANCE_MODE: strict
          DATA_RETENTION_DAYS: 90

      - name: Verify data anonymization
        run: npm run test:data-anonymization

      - name: Check encryption implementation
        run: npm run test:encryption-compliance

      - name: Validate audit trails
        run: npm run test:audit-trails

      - name: Generate GDPR compliance report
        run: npm run generate:gdpr-report

      - name: Upload compliance artifacts
        uses: actions/upload-artifact@v3
        with:
          name: gdpr-compliance-report
          path: reports/gdpr-compliance.html

  # ============================================================================
  # PERFORMANCE & LOAD TESTING
  # ============================================================================
  performance-testing:
    name: ‚ö° Performance Testing
    runs-on: ubuntu-latest
    needs: quality-assurance
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Run performance tests
        run: npm run test:performance
        timeout-minutes: 30

      - name: Load testing with Artillery
        run: |
          npm install -g artillery
          artillery run tests/load/trading-api-load-test.yml
        timeout-minutes: 15

      - name: Memory leak detection
        run: npm run test:memory-leaks

      - name: Upload performance reports
        uses: actions/upload-artifact@v3
        with:
          name: performance-reports
          path: reports/performance/

  # ============================================================================
  # STAGING DEPLOYMENT
  # ============================================================================
  deploy-staging:
    name: üöÄ Deploy to Staging
    runs-on: ubuntu-latest
    needs: [security-scan, container-security, gdpr-compliance, performance-testing]
    if: github.ref == 'refs/heads/develop'
    environment: staging
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_STAGING_ROLE_ARN }}
          aws-region: us-west-2

      - name: Deploy to EKS staging
        run: |
          aws eks update-kubeconfig --name trading-bot-staging
          kubectl apply -f k8s/staging/
          kubectl rollout restart deployment/trading-bot
          kubectl wait --for=condition=ready pod -l app=trading-bot --timeout=300s

      - name: Run smoke tests
        run: npm run test:smoke:staging
        env:
          STAGING_API_URL: ${{ secrets.STAGING_API_URL }}
          API_KEY: ${{ secrets.STAGING_API_KEY }}

      - name: Performance baseline check
        run: npm run test:performance:baseline
        env:
          TARGET_URL: ${{ secrets.STAGING_API_URL }}

  # ============================================================================
  # PRODUCTION DEPLOYMENT
  # ============================================================================
  deploy-production:
    name: üåü Deploy to Production
    runs-on: ubuntu-latest
    needs: deploy-staging
    if: github.event_name == 'release'
    environment: production
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_PRODUCTION_ROLE_ARN }}
          aws-region: us-east-1

      - name: Blue-Green deployment to EKS
        run: |
          aws eks update-kubeconfig --name trading-bot-production
          
          # Deploy to green environment
          kubectl apply -f k8s/production/
          kubectl set image deployment/trading-bot-green app=${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:${{ github.sha }}
          
          # Wait for green deployment
          kubectl rollout status deployment/trading-bot-green --timeout=600s
          
          # Health check on green
          kubectl exec deployment/trading-bot-green -- npm run health-check
          
          # Switch traffic to green (blue-green switch)
          kubectl patch service trading-bot-service -p '{"spec":{"selector":{"version":"green"}}}'
          
          # Wait and verify
          sleep 30
          kubectl exec deployment/trading-bot-green -- npm run health-check
          
          # Cleanup old blue deployment
          kubectl delete deployment trading-bot-blue || true

      - name: Production smoke tests
        run: npm run test:smoke:production
        env:
          PRODUCTION_API_URL: ${{ secrets.PRODUCTION_API_URL }}
          API_KEY: ${{ secrets.PRODUCTION_API_KEY }}

      - name: Notify deployment success
        uses: 8398a7/action-slack@v3
        with:
          status: success
          text: "üöÄ Trading Bot deployed successfully to production!"
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}

  # ============================================================================
  # POST-DEPLOYMENT MONITORING
  # ============================================================================
  post-deployment-monitoring:
    name: üìä Post-Deployment Monitoring
    runs-on: ubuntu-latest
    needs: deploy-production
    if: github.event_name == 'release'
    
    steps:
      - name: Setup monitoring alerts
        run: |
          # Configure DataDog alerts
          curl -X POST "https://api.datadoghq.com/api/v1/monitor" \
            -H "Content-Type: application/json" \
            -H "DD-API-KEY: ${{ secrets.DATADOG_API_KEY }}" \
            -H "DD-APPLICATION-KEY: ${{ secrets.DATADOG_APP_KEY }}" \
            -d '{
              "name": "Trading Bot - High Error Rate",
              "type": "metric alert",
              "query": "avg(last_5m):avg:trading_bot.error_rate{env:production} > 0.05",
              "message": "Trading bot error rate exceeds 5% in production @slack-alerts",
              "options": {
                "thresholds": {
                  "critical": 0.05,
                  "warning": 0.02
                }
              }
            }'

      - name: Run production health validation
        run: |
          sleep 300  # Wait 5 minutes for system to stabilize
          npm run test:production-health
        env:
          PRODUCTION_API_URL: ${{ secrets.PRODUCTION_API_URL }}
          MONITORING_INTERVAL: 60

  # ============================================================================
  # SECURITY MONITORING
  # ============================================================================
  security-monitoring:
    name: üõ°Ô∏è Continuous Security Monitoring
    runs-on: ubuntu-latest
    if: github.event_name == 'schedule' || github.event_name == 'workflow_dispatch'
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Daily dependency scan
        run: |
          npm audit --audit-level=high
          npm run security:dependencies

      - name: Infrastructure security scan
        run: |
          # Scan Kubernetes configs
          kubectl get pods --all-namespaces -o yaml | kube-score score -
          
          # Check for security policy violations
          kubectl auth can-i "*" "*" --as=system:anonymous || echo "Good: Anonymous access denied"

      - name: Generate security report
        run: npm run generate:security-report

      - name: Upload security artifacts
        uses: actions/upload-artifact@v3
        with:
          name: security-monitoring-report
          path: reports/security/
