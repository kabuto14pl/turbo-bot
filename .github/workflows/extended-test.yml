name: ğŸš€ Extended Trading Bot Test (2h) with Live Dashboard

on:
  # RÄ™czne uruchomienie z GitHub UI
  workflow_dispatch:
    inputs:
      test_duration:
        description: 'Test duration in hours (real-time)'
        required: false
        default: '2'
      time_multiplier:
        description: 'Time multiplier (simulation speed)'
        required: false
        default: '24'
  
  # Automatyczne uruchomienie codziennie o 3:00 UTC
  schedule:
    - cron: '0 3 * * *'
  
  # Uruchomienie przy push do main/master
  push:
    branches:
      - master
      - main
    paths:
      - 'trading-bot/**'
      - '.github/workflows/extended-test.yml'

jobs:
  extended-test:
    name: ğŸ§ª Extended Integration Test (2h Simulation)
    runs-on: ubuntu-latest
    timeout-minutes: 150  # 2.5h (z buforem)
    
    strategy:
      matrix:
        node-version: [20.x]
    
    steps:
      # ============================================================================
      # SETUP
      # ============================================================================
      
      - name: ğŸ“¥ Checkout Repository
        uses: actions/checkout@v4
      
      - name: ğŸŸ¢ Setup Node.js ${{ matrix.node-version }}
        uses: actions/setup-node@v4
        with:
          node-version: ${{ matrix.node-version }}
          cache: 'npm'
      
      - name: ğŸ“¦ Install Dependencies
        run: |
          npm ci
          npm run build
      
      - name: ğŸ”§ Setup Test Environment
        run: |
          # UtwÃ³rz katalogi
          mkdir -p logs data
          
          # Konfiguracja .env dla testu
          cat > .env.test << EOF
          MODE=simulation
          HEALTH_CHECK_PORT=3001
          TRADING_INTERVAL=1250
          REDIS_ENABLED=false
          TF_CPP_MIN_LOG_LEVEL=2
          TEST_MODE=accelerated
          TIME_MULTIPLIER=${{ github.event.inputs.time_multiplier || '24' }}
          NODE_ENV=test
          DISABLE_PRODUCTION_DEPLOYMENT=true
          DISABLE_DISTRIBUTED_ML=true
          EOF
          
          echo "âœ… Test environment configured"
          cat .env.test
      
      # ============================================================================
      # START TRADING BOT
      # ============================================================================
      
      - name: ğŸš€ Start Trading Bot (Background)
        run: |
          export $(cat .env.test | xargs)
          nohup npm exec ts-node -- trading-bot/autonomous_trading_bot_final.ts > logs/bot.log 2>&1 &
          BOT_PID=$!
          echo $BOT_PID > bot.pid
          echo "âœ… Bot started with PID: $BOT_PID"
          
          # Czekaj na inicjalizacjÄ™ (30s)
          echo "â³ Waiting for bot initialization..."
          sleep 30
          
          # SprawdÅº czy bot dziaÅ‚a
          if kill -0 $BOT_PID 2>/dev/null; then
            echo "âœ… Bot is running"
          else
            echo "âŒ Bot failed to start"
            cat logs/bot.log
            exit 1
          fi
      
      - name: ğŸ¥ Health Check
        run: |
          MAX_ATTEMPTS=20
          ATTEMPT=0
          
          while [ $ATTEMPT -lt $MAX_ATTEMPTS ]; do
            if curl -s -f http://localhost:3001/health > /dev/null; then
              echo "âœ… Bot health check passed"
              curl -s http://localhost:3001/health | jq .
              break
            fi
            ATTEMPT=$((ATTEMPT + 1))
            echo "â³ Health check attempt $ATTEMPT/$MAX_ATTEMPTS..."
            sleep 3
          done
          
          if [ $ATTEMPT -eq $MAX_ATTEMPTS ]; then
            echo "âŒ Health check failed after $MAX_ATTEMPTS attempts"
            cat logs/bot.log
            exit 1
          fi
      
      # ============================================================================
      # START UNIFIED DASHBOARD SERVER
      # ============================================================================
      
      - name: ğŸ“Š Start Unified Dashboard Server (Background)
        run: |
          nohup node unified_dashboard_server.js > logs/dashboard.log 2>&1 &
          DASHBOARD_PID=$!
          echo $DASHBOARD_PID > dashboard.pid
          echo "âœ… Dashboard server started with PID: $DASHBOARD_PID"
          
          # Czekaj na inicjalizacjÄ™
          sleep 5
          
          # SprawdÅº czy dashboard dziaÅ‚a
          if curl -s -f http://localhost:8080/health > /dev/null; then
            echo "âœ… Dashboard server is running"
          else
            echo "âŒ Dashboard server failed to start"
            cat logs/dashboard.log
            exit 1
          fi
      
      # ============================================================================
      # MONITORING LOOP (2 HOURS)
      # ============================================================================
      
      - name: ğŸ“ˆ Run Extended Test with Monitoring
        run: |
          TEST_DURATION=${{ github.event.inputs.test_duration || '2' }}
          DURATION_SECONDS=$((TEST_DURATION * 3600))
          CHECK_INTERVAL=120  # Check every 2 minutes
          
          echo "ğŸ§ª Starting Extended Test"
          echo "Duration: ${TEST_DURATION}h (${DURATION_SECONDS}s)"
          echo "Check interval: ${CHECK_INTERVAL}s"
          echo ""
          
          START_TIME=$(date +%s)
          END_TIME=$((START_TIME + DURATION_SECONDS))
          ITERATION=0
          
          # CSV header
          echo "timestamp,status,memory_mb,trades,portfolio_value,errors" > logs/monitoring.csv
          
          while [ $(date +%s) -lt $END_TIME ]; do
            ITERATION=$((ITERATION + 1))
            CURRENT_TIME=$(date +%s)
            ELAPSED=$((CURRENT_TIME - START_TIME))
            REMAINING=$((DURATION_SECONDS - ELAPSED))
            PROGRESS=$((ELAPSED * 100 / DURATION_SECONDS))
            
            # SprawdÅº czy bot dziaÅ‚a
            BOT_PID=$(cat bot.pid)
            if ! kill -0 $BOT_PID 2>/dev/null; then
              echo ""
              echo "âŒ [$(date '+%H:%M:%S')] Bot crashed!"
              echo "Last 100 lines of log:"
              tail -100 logs/bot.log
              exit 1
            fi
            
            # Pobierz metryki
            HEALTH=$(curl -s http://localhost:3001/health 2>/dev/null || echo '{"status":"unknown"}')
            PORTFOLIO=$(curl -s http://localhost:3001/api/portfolio 2>/dev/null || echo '{}')
            
            STATUS=$(echo $HEALTH | jq -r '.status // "unknown"')
            MEMORY=$(ps -p $BOT_PID -o rss= 2>/dev/null | awk '{print $1/1024}' || echo "0")
            TRADES=$(echo $PORTFOLIO | jq -r '.totalTrades // 0')
            PORTFOLIO_VALUE=$(echo $PORTFOLIO | jq -r '.totalValue // 10000')
            ERRORS=$(grep -c "ERROR\|Error" logs/bot.log 2>/dev/null || echo "0")
            
            # Zapisz do CSV
            echo "$CURRENT_TIME,$STATUS,$MEMORY,$TRADES,$PORTFOLIO_VALUE,$ERRORS" >> logs/monitoring.csv
            
            # Console output
            SIMULATED_HOURS=$((ELAPSED * ${{ github.event.inputs.time_multiplier || '24' }} / 3600))
            echo "â° [$ITERATION] Progress: ${PROGRESS}% | Elapsed: ${ELAPSED}s | Sim: ${SIMULATED_HOURS}h | Mem: ${MEMORY}MB | Trades: $TRADES | \$$PORTFOLIO_VALUE | Errors: $ERRORS | Remaining: ${REMAINING}s"
            
            # Zapisz snapshot co 10 minut
            if [ $((ELAPSED % 600)) -eq 0 ] && [ $ELAPSED -gt 0 ]; then
              echo "ğŸ’¾ Saving snapshot at ${SIMULATED_HOURS}h simulated time..."
              curl -s http://localhost:3001/api/portfolio > data/snapshot_${SIMULATED_HOURS}h.json || true
            fi
            
            sleep $CHECK_INTERVAL
          done
          
          echo ""
          echo "âœ… Test completed successfully!"
      
      # ============================================================================
      # CLEANUP & RESULTS
      # ============================================================================
      
      - name: ğŸ›‘ Stop Services
        if: always()
        run: |
          echo "ğŸ›‘ Stopping services..."
          
          # Stop bot
          if [ -f bot.pid ]; then
            BOT_PID=$(cat bot.pid)
            if kill -0 $BOT_PID 2>/dev/null; then
              kill $BOT_PID
              echo "âœ… Bot stopped (PID: $BOT_PID)"
            fi
          fi
          
          # Stop dashboard
          if [ -f dashboard.pid ]; then
            DASHBOARD_PID=$(cat dashboard.pid)
            if kill -0 $DASHBOARD_PID 2>/dev/null; then
              kill $DASHBOARD_PID
              echo "âœ… Dashboard stopped (PID: $DASHBOARD_PID)"
            fi
          fi
          
          sleep 5
      
      - name: ğŸ“Š Generate Test Report
        if: always()
        run: |
          echo "# ğŸ“Š Extended Test Report" > test_report.md
          echo "" >> test_report.md
          echo "**Test Duration:** ${{ github.event.inputs.test_duration || '2' }} hours" >> test_report.md
          echo "**Time Multiplier:** ${{ github.event.inputs.time_multiplier || '24' }}x" >> test_report.md
          echo "**Simulated Time:** $(((${{ github.event.inputs.test_duration || '2' }} * ${{ github.event.inputs.time_multiplier || '24' }}))) hours" >> test_report.md
          echo "" >> test_report.md
          
          # Portfolio metrics
          if [ -f logs/monitoring.csv ]; then
            FINAL_PORTFOLIO=$(tail -1 logs/monitoring.csv | cut -d',' -f5)
            FINAL_TRADES=$(tail -1 logs/monitoring.csv | cut -d',' -f4)
            TOTAL_ERRORS=$(tail -1 logs/monitoring.csv | cut -d',' -f6)
            
            echo "## ğŸ’° Final Results" >> test_report.md
            echo "- **Portfolio Value:** \$${FINAL_PORTFOLIO}" >> test_report.md
            echo "- **Total Trades:** ${FINAL_TRADES}" >> test_report.md
            echo "- **Total Errors:** ${TOTAL_ERRORS}" >> test_report.md
            echo "" >> test_report.md
          fi
          
          # Memory stats
          echo "## ğŸ“Š Performance Metrics" >> test_report.md
          if [ -f logs/monitoring.csv ]; then
            AVG_MEMORY=$(awk -F',' 'NR>1 {sum+=$3; count++} END {print sum/count}' logs/monitoring.csv)
            MAX_MEMORY=$(awk -F',' 'NR>1 {max=($3>max)?$3:max} END {print max}' logs/monitoring.csv)
            echo "- **Average Memory:** ${AVG_MEMORY}MB" >> test_report.md
            echo "- **Peak Memory:** ${MAX_MEMORY}MB" >> test_report.md
          fi
          echo "" >> test_report.md
          
          # Errors
          echo "## âš ï¸ Error Summary" >> test_report.md
          echo "\`\`\`" >> test_report.md
          grep -i "error" logs/bot.log | tail -20 >> test_report.md || echo "No errors found" >> test_report.md
          echo "\`\`\`" >> test_report.md
          
          cat test_report.md
      
      - name: ğŸ“¤ Upload Test Results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: test-results-${{ github.run_number }}
          path: |
            logs/
            data/
            test_report.md
          retention-days: 30
          if-no-files-found: warn
      
      - name: ğŸ“¤ Upload Bot Logs
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: bot-logs-${{ github.run_number }}
          path: logs/bot.log
          retention-days: 30
          if-no-files-found: warn
      
      - name: ğŸ“¤ Upload Dashboard Logs
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: dashboard-logs-${{ github.run_number }}
          path: logs/dashboard.log
          retention-days: 30
          if-no-files-found: warn
      
      # ============================================================================
      # NOTIFICATIONS (Optional)
      # ============================================================================
      
      - name: ğŸ“¢ Test Summary
        if: always()
        run: |
          echo "## ğŸ§ª Extended Test Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          if [ -f test_report.md ]; then
            cat test_report.md >> $GITHUB_STEP_SUMMARY
          fi
          
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ğŸ“Š Artifacts" >> $GITHUB_STEP_SUMMARY
          echo "- Test results: \`test-results-${{ github.run_number }}\`" >> $GITHUB_STEP_SUMMARY
          echo "- Bot logs: \`bot-logs-${{ github.run_number }}\`" >> $GITHUB_STEP_SUMMARY
          echo "- Dashboard logs: \`dashboard-logs-${{ github.run_number }}\`" >> $GITHUB_STEP_SUMMARY
      
      - name: âœ… Test Passed
        if: success()
        run: |
          echo "ğŸ‰ Extended test completed successfully!"
          echo "Test results available in artifacts"
      
      - name: âŒ Test Failed
        if: failure()
        run: |
          echo "âŒ Extended test failed!"
          echo "Check logs in artifacts for details"
          exit 1
