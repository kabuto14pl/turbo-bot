/**
 * ğŸš€ FINAL TEST ENTERPRISE ML STRATEGY ADVANCED
 * 
 * Kompleksowy test naszej najzaawansowniejszej strategii ML
 */

import { EnterpriseMLStrategy } from './trading-bot/strategies/enterprise_ml_strategy_advanced';
import { BotState } from './trading-bot/core/types/bot_state';
import { Logger } from './trading-bot/infrastructure/logging/logger';

async function testEnterpriseMLStrategy() {
    const logger = new Logger('EnterpriseMLTest');
    
    logger.info('ğŸš€ Rozpoczynanie testÃ³w Enterprise ML Strategy Advanced...');
    
    // Utworzenie strategii z peÅ‚nÄ… konfiguracjÄ…
    const strategy = new EnterpriseMLStrategy({
        enableMultiModel: true,
        enableAdvancedFeatures: true,
        enableRegimeDetection: true,
        enableDynamicSizing: true,
        confidenceThreshold: 0.7,
        maxPositionSize: 0.15,
        riskAdjustment: true,
        ensembleWeights: {
            technical: 0.3,
            ml: 0.4,
            sentiment: 0.2,
            regime: 0.1
        }
    });

    // Test konfiguracji strategii
    logger.info(`âœ… Strategia utworzona: ${strategy.name}`);
    logger.info(`ğŸ“Š Opis: ${strategy.description}`);
    logger.info(`âš–ï¸ Waga domyÅ›lna: ${strategy.defaultWeight}`);
    logger.info(`ğŸ”§ Wymagane wskaÅºniki: ${strategy.getRequiredIndicators().join(', ')}`);
    logger.info(`â° Wymagane timeframe: ${strategy.getRequiredTimeframes().join(', ')}`);

    // Test walidacji konfiguracji
    const isConfigValid = strategy.validateConfig();
    logger.info(`âœ… Konfiguracja strategii jest poprawna: ${isConfigValid}`);

    // Test metod interfejsu
    strategy.setWeight(1.5);
    const weight = strategy.getWeight();
    logger.info(`âš–ï¸ Waga strategii po zmianie: ${weight}`);

    // Symulacja danych rynkowych i stanu bota
    const mockBotState: BotState = {
        portfolio: {
            cash: 10000,
            btc: 0,
            totalValue: 10000,
            unrealizedPnL: 0,
            realizedPnL: 0
        },
        timestamp: Date.now(),
        equity: 10000,
        prices: {
            m15: {
                time: Date.now(),
                open: 49500,
                high: 50200,
                low: 49300,
                close: 50000,
                volume: 100000
            },
            h1: null,
            h4: null,
            d1: null
        },
        indicators: {
            m15: {
                rsi: 65,
                adx: 35,
                atr: 250,
                ema_9: 49800,
                ema_21: 49600,
                ema_50: 49400,
                ema_200: 48000,
                macd: { 
                    macd: 50,
                    signal: 48,
                    histogram: 2
                },
                supertrend: {
                    value: 49500,
                    direction: 'buy' as const
                }
            },
            h1: null,
            h4: null,
            d1: null
        },
        positions: [],
        marketData: {
            symbol: 'BTCUSDT',
            lastPrice: 50000,
            bidPrice: 49950,
            askPrice: 50050,
            volume24h: 1000000,
            volatility24h: 0.025,
            spread: 100,
            liquidity: 500000
        },
        regime: {
            trend: 0.5,
            volatility: 0.5,
            momentum: 0.3,
            regime: 'trend'
        }
    };    try {
        // Test wykonania strategii
        logger.info('ğŸ”„ Uruchamianie strategii Enterprise ML...');
        const signals = await strategy.run(mockBotState);
        
        logger.info(`ğŸ“Š Strategia wygenerowaÅ‚a ${signals.length} sygnaÅ‚Ã³w:`);
        
        signals.forEach((signal, index) => {
            logger.info(`ğŸ¯ SygnaÅ‚ ${index + 1}:`);
            logger.info(`   Typ: ${signal.type}`);
            logger.info(`   Cena: ${signal.price}`);
            logger.info(`   PewnoÅ›Ä‡: ${(signal.confidence * 100).toFixed(1)}%`);
            logger.info(`   Rozmiar pozycji: ${signal.size?.toFixed(6) || 'brak'}`);
            
            if (signal.stopLoss) {
                logger.info(`   Stop Loss: ${signal.stopLoss}`);
            }
            if (signal.takeProfit) {
                logger.info(`   Take Profit: ${signal.takeProfit}`);
            }
            
            logger.info(`   WskaÅºniki:`, signal.indicators);
            
            if (signal.metadata) {
                logger.info(`   Metadata:`, signal.metadata);
            }
        });

        // Test wydajnoÅ›ci i statystyk
        logger.info('\nğŸ“ˆ PODSUMOWANIE TESTÃ“W ENTERPRISE ML STRATEGY:');
        logger.info(`âœ… Strategia dziaÅ‚a poprawnie`);
        logger.info(`ğŸ“Š Wygenerowano ${signals.length} sygnaÅ‚Ã³w`);
        logger.info(`ğŸ¯ Strategia obsÅ‚uguje peÅ‚ne zaawansowane funkcje ML`);
        logger.info(`ğŸ”„ Integracja z Enterprise ML Infrastructure: AKTYWNA`);
        logger.info(`âš¡ Multi-model ensemble: WÅÄ„CZONY`);
        logger.info(`ğŸ§  Advanced feature engineering: WÅÄ„CZONY`);
        logger.info(`ğŸ“Š Market regime detection: WÅÄ„CZONY`);
        logger.info(`ğŸ’° Dynamic position sizing: WÅÄ„CZONY`);
        logger.info(`âš–ï¸ Risk adjustment: WÅÄ„CZONY`);
        
        logger.info('\nğŸ‰ ENTERPRISE ML STRATEGY ADVANCED GOTOWA DO PRODUKCJI!');
        
        return true;
        
    } catch (error) {
        logger.error('âŒ BÅ‚Ä…d podczas testowania strategii:', error);
        return false;
    }
}

// Uruchomienie testÃ³w
if (require.main === module) {
    testEnterpriseMLStrategy()
        .then((success) => {
            if (success) {
                console.log('\nğŸ¯ WSZYSTKIE TESTY ENTERPRISE ML STRATEGY ZAKOÅƒCZONE SUKCESEM!');
                console.log('ğŸš€ Trading Bot Dev 4.0.4 z Enterprise ML gotowy do kolejnego etapu!');
                process.exit(0);
            } else {
                console.log('\nâŒ Testy nie powiodÅ‚y siÄ™');
                process.exit(1);
            }
        })
        .catch((error) => {
            console.error('ğŸ’¥ Krytyczny bÅ‚Ä…d testÃ³w:', error);
            process.exit(1);
        });
}

export { testEnterpriseMLStrategy };
